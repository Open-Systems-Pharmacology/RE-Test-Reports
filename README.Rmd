---
title: "Reporting Engine Test Reports"
author: "Open System Pharmacology"
date: "`r Sys.Date()`"
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
```

<!-- 
Run testthat and get list of test results 
Note that "test_local" runs the scripts in ./R and then performs the tests
testResults includes a list per test script, which contains the following results
file, context, test, nb, failed, skipped, error, warning, user, system, real, passed, result

Turning the list to data.frame and extracting the relevant data will give a great overview of the test results
-->

```{r, include=FALSE}
# Remove previous tests
unlink("./tests/Reports", recursive = TRUE, force = TRUE)

# Prevent failed tests to stop the workflow
testResultsRaw <- testthat::test_local(
  reporter = testthat::ListReporter,
  stop_on_failure = FALSE
)
testResultsRaw <- as.data.frame(testResultsRaw)
testResults <- testResultsRaw %>%
  mutate(
    Report = paste0("[", context, "](./tests/Reports/", context, ")"),
    Test = test,
    Status = if_else(
      failed > 0,
      "![](https://img.shields.io/badge/%E2%9A%A0-Failed%20tests-red)",
      if_else(
        warning > 0,
        "![](https://img.shields.io/badge/%E2%9A%A0-Warned%20tests-red)",
        "![](https://img.shields.io/badge/%E2%9C%93-Passed%20tests-success)"
      )
    ),
    Duration = real,
    N = if_else(skipped, 0, nb),
    Success = if_else(nb ==0 | skipped, "", paste0(
      "![](https://geps.dev/progress/",
      round(100 * passed / nb, 0),
      ")"
    )),
    Warning = if_else(nb ==0 | skipped, "", paste0(round(100 * warning / nb, 0), "%")),
    Failed = if_else(nb ==0 | skipped, "", paste0(round(100 * failed / nb, 0), "%"))
  ) %>%
  filter(N > 0) %>%
  select(Report, Test, Status, N, Success, Warning, Failed)

totalReports <- n_distinct(testResults$Report)
totalTests <- sum(testResults$N)
globalResult <- round(100 * sum(testResultsRaw$passed) / totalTests, 0)
```


| &#x1F4D4; Total Reports | &#x1F575; Total Tests | &#x1F4CA; Global Success Rate |
|-------------------------|-----------------------|-------------------------------|
| `r totalReports` | `r totalTests` | ![](https://geps.dev/progress/`r globalResult`) |


## Using Reports and Scripts as template

Users can find the reports and their description in the [/Reports](./Reports) folder as well as the corresponding R code in the [/R](./R) folder.

Models, Observed and Simulated Data are respectively available in the [Models](./Models) and [Data](./Data) folders.

Here is the summary of the reports, their scripts and their run time currently available in this repository:

```{r, results='asis'}
reportMappings <- jsonlite::fromJSON("tests/testthat/report-mapping.json", simplifyVector = TRUE)
list.dirs("./tests/Reports", recursive = FALSE, full.names = FALSE)
availableDurations <- unname(sapply(
  reportMappings$Report,
  function(reportDir) {
    logInfo <- readLines(file.path("tests", "Reports", reportDir, "log-info.txt"), warn = FALSE)
    lastLine <- tail(logInfo[grepl(pattern = "completed in", logInfo)], 1)
    duration <- tail(unlist(strsplit(split = "completed in", x = lastLine)), 1)
    return(trimws(duration))
  }
))

knitr::kable(data.frame(
  "Reference" = paste0(
    "[", reportMappings$Report, "](", 
    ifelse(reportMappings$Reference, ".", "https://github.com/Open-Systems-Pharmacology"), 
    "/Reports/", reportMappings$Report, ")"
    ),
  "Test Report" = paste0("[", reportMappings$Report, "](./tests/Reports/", reportMappings$Report, "/Report.md)"),
  "Script" = paste0("[", reportMappings$Script, ".R](./R/", reportMappings$Script, ".R)"),
  "Run Time" = availableDurations,
  check.names = FALSE
))
```

## Test Results

```{r, results='asis'}
names(testResults) <- c("Report", "Test", "Status", "N", "Success [%]", "Warning [%]", "Failed [%]")

knitr::kable(testResults)
```
