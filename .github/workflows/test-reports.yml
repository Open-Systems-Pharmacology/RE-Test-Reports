name: Run RE Report Tests

on: 
  push:
  pull_request:
  schedule:
    - cron: '0 0 * * 1'

permissions:
  contents: write
  issues: write
  
jobs:
  test-reports:
    runs-on: windows-latest
    # Allow only authorized collaborators to trigger GA:
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Qualification Environment
        uses: Open-Systems-Pharmacology/Workflows/.github/actions/setup-qualification-environment@main
        with:
          tools-path: tools.csv
      
      - name: Run Tests through README.Rmd
        run: |
          install.packages(c('testthat','covr','rmarkdown','pkgdown'))
          remotes::install_github('Open-Systems-Pharmacology/OSPSuite.QualificationPlanEditor')
          rmarkdown::render("README.Rmd", encoding = "UTF-8")
        shell: Rscript {0}
      
      - name: Save test results as zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-log
          path: log.json
      
      - name: Commit and push test files
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add README.md || echo "No changes in README"
          git add ./tests/Reports || echo "No changes in Test Reports"
          git commit -m "Added/modified test reports and updated README" || echo "No changes to commit"
          git push origin
  
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: test-reports
    if: ${{ failure() && needs.test-reports.result == 'failure' && github.event_name == 'schedule' }}
    permissions:
      issues: write
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Test Reports Workflow Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Workflow Failure Report
            
            The test-reports workflow has failed.
            
            **Workflow Run:** [${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            **Branch:** ${context.ref}
            **Commit:** ${context.sha.substring(0, 7)}
            **Triggered by:** ${context.eventName}
            **Actor:** ${context.actor}
            
            Please investigate the failure and take appropriate action.
            
            ---
            *This issue was automatically created by the test-reports.yml workflow.*`,
              assignees: ['pchelle', 'Yuri05'],
              labels: ['bug', 'automated']
            });
            console.log(`Created issue #${issue.data.number}`)
